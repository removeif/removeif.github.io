<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/remove.io/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/remove.io/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/remove.io/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/removeif/removeif.github.io@master/images/wico.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="https://cdn.jsdelivr.net/gh/removeif/removeif.github.io@master/images/wico.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="https://cdn.jsdelivr.net/gh/removeif/removeif.github.io@master/images/wico.png?v=5.1.4">


  <link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif.github.io@master/images/wico.png?v=5.1.4" color="#222">





  <meta name="keywords" content="mysql">





  <link rel="alternate" href="/remove.io/atom.xml" title="辣椒の酱" type="application/atom+xml">






<meta name="description" content="摘要某天晚上，同事正在发布，突然线上大量报警，很多是关于数据库死锁的，报警提示信息如下：">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="一次数据库的死锁问题排查过程">
<meta property="og:url" content="https://removeif.github.io/database/mysql/一次数据库的死锁问题排查过程.html">
<meta property="og:site_name" content="辣椒の酱">
<meta property="og:description" content="摘要某天晚上，同事正在发布，突然线上大量报警，很多是关于数据库死锁的，报警提示信息如下：">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110409.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110452.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110517.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110555.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110615.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110635.png">
<meta property="og:updated_time" content="2019-09-25T08:32:54.323Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一次数据库的死锁问题排查过程">
<meta name="twitter:description" content="摘要某天晚上，同事正在发布，突然线上大量报警，很多是关于数据库死锁的，报警提示信息如下：">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110409.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/remove.io/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://removeif.github.io/database/mysql/一次数据库的死锁问题排查过程.html">





  <title>一次数据库的死锁问题排查过程 | 辣椒の酱</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/remove.io/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">辣椒の酱</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">尚未执佩剑，转眼即江湖</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/remove.io/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/remove.io/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/remove.io/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/remove.io/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-留言">
          <a href="https://removeif.github.io/message/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            留言
          </a>
        </li>
      
        
        <li class="menu-item menu-item-主站">
          <a href="https://removeif.github.io/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            主站
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://removeif.github.io/remove.io/database/mysql/一次数据库的死锁问题排查过程.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="辣椒の酱">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/removeif/removeif.github.io@master/images/tuzi.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="辣椒の酱">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">一次数据库的死锁问题排查过程</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-25T11:11:56+08:00">
                2019-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/remove.io/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/remove.io/categories/数据库/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>摘要<br>某天晚上，同事正在发布，突然线上大量报警，很多是关于数据库死锁的，报警提示信息如下：<br><a id="more"></a></p>
</blockquote>
<h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p>某天晚上，同事正在发布，突然线上大量报警，很多是关于数据库死锁的，报警提示信息如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;"errorCode":"SYSTEM_ERROR","errorMsg":"nested exception is org.apache.ibatis.exceptions.PersistenceException: </span><br><span class="line"></span><br><span class="line">Error updating database. Cause: ERR-CODE: [TDDL-4614][ERR_EXECUTE_ON_MYSQL] </span><br><span class="line"></span><br><span class="line">Deadlock found when trying to get <span class="keyword">lock</span>; </span><br><span class="line"></span><br><span class="line">The error occurred while setting parameters\n<span class="comment">### SQL: </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> fund_transfer_stream <span class="keyword">set</span> gmt_modified=<span class="keyword">now</span>(),state = ? <span class="keyword">where</span> fund_transfer_order_no = ? <span class="keyword">and</span> seller_id = ? <span class="keyword">and</span> state = <span class="string">'NEW'</span></span><br></pre></td></tr></table></figure>
<p>通过报警，我们基本可以定位到发生死锁的数据库以及数据库表。先来介绍下本文案例中涉及到的数据库相关信息。</p>
<h3 id="背景情况"><a href="#背景情况" class="headerlink" title="背景情况"></a>背景情况</h3><p>我们使用的数据库是Mysql 5.7，引擎是InnoDB，事务隔离级别是READ-COMMITED。</p>
<p>数据库版本查询方法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">version</span>();</span><br></pre></td></tr></table></figure>
<p>引擎查询方法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> fund_transfer_stream;</span><br></pre></td></tr></table></figure>
<p>建表语句中会显示存储引擎信息，形如：<code>ENGINE=InnoDB</code></p>
<p>事务隔离级别查询方法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @@tx_isolation;</span><br></pre></td></tr></table></figure>
<p>事务隔离级别设置方法（只对当前Session生效）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">session</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">read</span> committed;</span><br></pre></td></tr></table></figure>
<p>PS：注意，如果数据库是分库的，以上几条SQL语句需要在单库上执行，不要在逻辑库执行。</p>
<p>发生死锁的表结构及索引情况（隐去了部分无关字段和索引）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`fund_transfer_stream`</span> ( </span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键'</span>,</span><br><span class="line">  <span class="string">`gmt_create`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`gmt_modified`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'修改时间'</span>, </span><br><span class="line">  <span class="string">`pay_scene_name`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付场景名称'</span>, </span><br><span class="line">  <span class="string">`pay_scene_version`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付场景版本'</span>,</span><br><span class="line">  <span class="string">`identifier`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'唯一性标识'</span>,</span><br><span class="line">  <span class="string">`seller_id`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'卖家Id'</span>,</span><br><span class="line">  <span class="string">`state`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'状态'</span>, <span class="string">`fund_transfer_order_no`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) </span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'资金平台返回的状态'</span>, </span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),<span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uk_scene_identifier`</span> </span><br><span class="line">  (<span class="keyword">KEY</span> <span class="string">`idx_seller`</span> (<span class="string">`seller_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_seller_transNo`</span> (<span class="string">`seller_id`</span>,<span class="string">`fund_transfer_order_no`</span>(<span class="number">20</span>))</span><br><span class="line">  ) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'资金流水'</span>;</span><br></pre></td></tr></table></figure>
<p>该数据库共有三个索引，1个聚簇索引（主键索引），2个非聚簇索（非主键索引）引。</p>
<p>聚簇索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRIMARY KEY (`id`)</span><br></pre></td></tr></table></figure>
<p>非聚簇索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KEY `idx_seller` (`seller_id`),</span><br><span class="line"></span><br><span class="line">KEY `idx_seller_transNo` (`seller_id`,`fund_transfer_order_no`(20))</span><br></pre></td></tr></table></figure>
<p>以上两个索引，其实idx_seller_transNo已经覆盖到了idx_seller，由于历史原因，因为该表以seller_id分表，所以是先有的idx_seller，后有的idx_seller_transNo</p>
<h3 id="死锁日志"><a href="#死锁日志" class="headerlink" title="死锁日志"></a>死锁日志</h3><p>当数据库发生死锁时，可以通过以下命令获取死锁日志：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">engine</span> <span class="keyword">innodb</span> <span class="keyword">status</span></span><br></pre></td></tr></table></figure>
<p>发生死锁，第一时间查看死锁日志，得到死锁日志内容如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Transactions deadlock detected, dumping detailed information.</span><br><span class="line">2019-03-19T21:44:23.516263+08:00 5877341 [Note] InnoDB: </span><br><span class="line"></span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 173268495, ACTIVE 0 sec fetching rows</span><br><span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, <span class="keyword">locked</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">LOCK</span> <span class="keyword">WAIT</span> <span class="number">304</span> <span class="keyword">lock</span> <span class="keyword">struct</span>(s), <span class="keyword">heap</span> <span class="keyword">size</span> <span class="number">41168</span>, <span class="number">6</span> <span class="keyword">row</span> <span class="keyword">lock</span>(s), <span class="keyword">undo</span> <span class="keyword">log</span> entries <span class="number">1</span></span><br><span class="line">MySQL <span class="keyword">thread</span> <span class="keyword">id</span> <span class="number">5877358</span>, OS <span class="keyword">thread</span> handle <span class="number">47356539049728</span>, <span class="keyword">query</span> <span class="keyword">id</span> <span class="number">557970181</span> <span class="number">11.183</span><span class="number">.244</span><span class="number">.150</span> fin_instant_app updating</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> <span class="string">`fund_transfer_stream`</span> <span class="keyword">set</span> <span class="string">`gmt_modified`</span> = <span class="keyword">NOW</span>(), <span class="string">`state`</span> = <span class="string">'PROCESSING'</span> <span class="keyword">where</span> ((<span class="string">`state`</span> = <span class="string">'NEW'</span>) <span class="keyword">AND</span> (<span class="string">`seller_id`</span> = <span class="string">'38921111'</span>) <span class="keyword">AND</span> (<span class="string">`fund_transfer_order_no`</span> = <span class="string">'99010015000805619031958363857'</span>))</span><br><span class="line"><span class="number">2019</span><span class="number">-03</span><span class="number">-19</span>T21:<span class="number">44</span>:<span class="number">23.516321</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">5877341</span> [Note] <span class="keyword">InnoDB</span>: </span><br><span class="line"></span><br><span class="line">*** (<span class="number">1</span>) HOLDS THE <span class="keyword">LOCK</span>(S):</span><br><span class="line"><span class="built_in">RECORD</span> LOCKS <span class="keyword">space</span> <span class="keyword">id</span> <span class="number">173</span> page <span class="keyword">no</span> <span class="number">13726</span> n bits <span class="number">248</span> <span class="keyword">index</span> idx_seller_transNo <span class="keyword">of</span> <span class="keyword">table</span> <span class="string">`xxx`</span>.<span class="string">`fund_transfer_stream`</span> trx <span class="keyword">id</span> <span class="number">173268495</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line"><span class="built_in">Record</span> <span class="keyword">lock</span>, <span class="keyword">heap</span> <span class="keyword">no</span> <span class="number">168</span> <span class="keyword">PHYSICAL</span> <span class="built_in">RECORD</span>: n_fields <span class="number">3</span>; compact format; info bits 0</span><br><span class="line"></span><br><span class="line">2019-03-19T21:44:23.516565+08:00 5877341 [Note] InnoDB: </span><br><span class="line"></span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 173 page no 12416 n bits 128 index PRIMARY of table `xxx`.`fund_transfer_stream` trx id 173268495 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record <span class="keyword">lock</span>, <span class="keyword">heap</span> <span class="keyword">no</span> <span class="number">56</span> <span class="keyword">PHYSICAL</span> <span class="built_in">RECORD</span>: n_fields <span class="number">17</span>; compact format; info bits 0</span><br><span class="line">2019-03-19T21:44:23.517793+08:00 5877341 [Note] InnoDB: </span><br><span class="line"></span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 173268500, ACTIVE 0 sec fetching rows, thread declared inside InnoDB 81</span><br><span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, <span class="keyword">locked</span> <span class="number">1</span></span><br><span class="line"><span class="number">302</span> <span class="keyword">lock</span> <span class="keyword">struct</span>(s), <span class="keyword">heap</span> <span class="keyword">size</span> <span class="number">41168</span>, <span class="number">2</span> <span class="keyword">row</span> <span class="keyword">lock</span>(s), <span class="keyword">undo</span> <span class="keyword">log</span> entries <span class="number">1</span></span><br><span class="line">MySQL <span class="keyword">thread</span> <span class="keyword">id</span> <span class="number">5877341</span>, OS <span class="keyword">thread</span> handle <span class="number">47362313119488</span>, <span class="keyword">query</span> <span class="keyword">id</span> <span class="number">557970189</span> <span class="number">11.131</span><span class="number">.81</span><span class="number">.107</span> fin_instant_app updating</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> <span class="string">`fund_transfer_stream_0056`</span> <span class="keyword">set</span> <span class="string">`gmt_modified`</span> = <span class="keyword">NOW</span>(), <span class="string">`state`</span> = <span class="string">'PROCESSING'</span> <span class="keyword">where</span> ((<span class="string">`state`</span> = <span class="string">'NEW'</span>) <span class="keyword">AND</span> (<span class="string">`seller_id`</span> = <span class="string">'38921111'</span>) <span class="keyword">AND</span> (<span class="string">`fund_transfer_order_no`</span> = <span class="string">'99010015000805619031957477256'</span>))</span><br><span class="line"><span class="number">2019</span><span class="number">-03</span><span class="number">-19</span>T21:<span class="number">44</span>:<span class="number">23.517855</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">5877341</span> [Note] <span class="keyword">InnoDB</span>: </span><br><span class="line"></span><br><span class="line">*** (<span class="number">2</span>) HOLDS THE <span class="keyword">LOCK</span>(S):</span><br><span class="line"><span class="built_in">RECORD</span> LOCKS <span class="keyword">space</span> <span class="keyword">id</span> <span class="number">173</span> page <span class="keyword">no</span> <span class="number">12416</span> n bits <span class="number">128</span> <span class="keyword">index</span> PRIMARY <span class="keyword">of</span> <span class="keyword">table</span> <span class="string">`fin_instant_0003`</span>.<span class="string">`fund_transfer_stream_0056`</span> trx <span class="keyword">id</span> <span class="number">173268500</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line"><span class="built_in">Record</span> <span class="keyword">lock</span>, <span class="keyword">heap</span> <span class="keyword">no</span> <span class="number">56</span> <span class="keyword">PHYSICAL</span> <span class="built_in">RECORD</span>: n_fields <span class="number">17</span>; compact format; info bits 0</span><br><span class="line"></span><br><span class="line">2019-03-19T21:44:23.519053+08:00 5877341 [Note] InnoDB: </span><br><span class="line"></span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 173 page no 13726 n bits 248 index idx_seller_transNo of table `fin_instant_0003`.`fund_transfer_stream_0056` trx id 173268500 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record <span class="keyword">lock</span>, <span class="keyword">heap</span> <span class="keyword">no</span> <span class="number">168</span> <span class="keyword">PHYSICAL</span> <span class="built_in">RECORD</span>: n_fields <span class="number">3</span>; compact format; info bits 0</span><br><span class="line"></span><br><span class="line">2019-03-19T21:44:23.519297+08:00 5877341 [Note] InnoDB: *** WE ROLL BACK TRANSACTION (2)</span><br></pre></td></tr></table></figure>
<p>简单解读一下死锁日志，可以得到以下信息：</p>
<p>1、导致死锁的两条SQL语句分别是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="string">`fund_transfer_stream_0056`</span> </span><br><span class="line"><span class="keyword">set</span> <span class="string">`gmt_modified`</span> = <span class="keyword">NOW</span>(), <span class="string">`state`</span> = <span class="string">'PROCESSING'</span> </span><br><span class="line"><span class="keyword">where</span> ((<span class="string">`state`</span> = <span class="string">'NEW'</span>) <span class="keyword">AND</span> (<span class="string">`seller_id`</span> = <span class="string">'38921111'</span>) <span class="keyword">AND</span> (<span class="string">`fund_transfer_order_no`</span> = <span class="string">'99010015000805619031957477256'</span>))</span><br></pre></td></tr></table></figure>
<p>和</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="string">`fund_transfer_stream_0056`</span> </span><br><span class="line"><span class="keyword">set</span> <span class="string">`gmt_modified`</span> = <span class="keyword">NOW</span>(), <span class="string">`state`</span> = <span class="string">'PROCESSING'</span> </span><br><span class="line"><span class="keyword">where</span> ((<span class="string">`state`</span> = <span class="string">'NEW'</span>) <span class="keyword">AND</span> (<span class="string">`seller_id`</span> = <span class="string">'38921111'</span>) <span class="keyword">AND</span> (<span class="string">`fund_transfer_order_no`</span> = <span class="string">'99010015000805619031958363857'</span>))</span><br></pre></td></tr></table></figure>
<p>2、事务1，持有索引idx_seller_transNo的锁，在等待获取PRIMARY的锁。</p>
<p>3、事务2，持有PRIMARY的锁，在等待获取idx_seller_transNo的锁。</p>
<p>4、因事务1和事务2之间发生循环等待，故发生死锁。</p>
<p>5、事务1和事务2当前持有的锁均为：<code>lock_mode X locks rec but not gap</code></p>
<p>两个事务对记录加的都是X 锁，No Gap锁，即对当行记录加锁，并为加间隙锁。</p>
<blockquote>
<p>X锁：排他锁、又称写锁。若事务T对数据对象A加上X锁，事务T可以读A也可以修改A，其他事务不能再对A加任何锁，直到T释放A上的锁。这保证了其他事务在T释放A上的锁之前不能再读取和修改A。</p>
<p>与之对应的是S锁：共享锁，又称读锁，若事务T对数据对象A加上S锁，则事务T可以读A但不能修改A，其他事务只能再对A加S锁，而不能加X锁，直到T释放A上的S锁。这保证了其他事务可以读A，但在T释放A上的S锁之前不能对A做任何修改。</p>
<p>Gap Lock：间隙锁，锁定一个范围，但不包括记录本身。GAP锁的目的，是为了防止同一事务的两次当前读，出现幻读的情况。</p>
<p>Next-Key Lock：1+2，锁定一个范围，并且锁定记录本身。对于行的查询，都是采用该方法，主要目的是解决幻读的问题。</p>
</blockquote>
<p>详见：<a href="https://www.cnblogs.com/zhoujinyi/p/3435982.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhoujinyi/p/3435982.html</a> 、 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html</a></p>
<h3 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h3><p>根据我们目前已知的数据库相关信息，以及死锁的日志，我们基本可以做一些简单的判定。</p>
<p>首先，<strong>此次死锁一定是和Gap锁以及Next-Key Lock没有关系的</strong>。因为我们的数据库隔离级别是RC（READ-COMMITED）的，这种隔离级别是不会添加Gap锁的。前面的死锁日志也提到这一点。</p>
<p>然后，就要翻代码了，看看我们的代码中事务到底是怎么做的。核心代码及SQL如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Transactional(rollbackFor = Exception.class)</span><br><span class="line">public int doProcessing(String sellerId, Long id, String fundTransferOrderNo) &#123;</span><br><span class="line">    fundTreansferStreamDAO.updateFundStreamId(sellerId, id, fundTransferOrderNo);</span><br><span class="line">    return fundTreansferStreamDAO.updateStatus(sellerId, fundTransferOrderNo, FundTransferStreamState.PROCESSING.name());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该代码的目的是先后修改同一条记录的两个不同字段，updateFundStreamId SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> fund_transfer_stream</span><br><span class="line">        <span class="keyword">set</span> gmt_modified=<span class="keyword">now</span>(),fund_transfer_order_no = <span class="comment">#&#123;fundTransferOrderNo&#125;</span></span><br><span class="line">        <span class="keyword">where</span> <span class="keyword">id</span> = <span class="comment">#&#123;id&#125; and seller_id = #&#123;sellerId&#125;</span></span><br></pre></td></tr></table></figure>
<p>updateStatus SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> fund_transfer_stream</span><br><span class="line">    <span class="keyword">set</span> gmt_modified=<span class="keyword">now</span>(),state = <span class="comment">#&#123;state&#125;</span></span><br><span class="line">    <span class="keyword">where</span> fund_transfer_order_no = <span class="comment">#&#123;fundTransferOrderNo&#125; and seller_id = #&#123;sellerId&#125;</span></span><br><span class="line">    <span class="keyword">and</span> state = <span class="string">'NEW'</span></span><br></pre></td></tr></table></figure>
<p>可以看到，我们的同一个事务中执行了两条Update语句，这里分别查看下两条SQL的执行计划：</p>
<p><img src="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110409.png" alt=""></p>
<p>updateFundStreamId执行的时候使用到的是PRIMARY索引。</p>
<p><img src="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110452.png" alt=""></p>
<p>updateStatus执行的时候使用到的是idx_seller_transNo索引。</p>
<blockquote>
<p>通过执行计划，我们发现updateStatus其实是有两个索引可以用的，执行的时候真正使用的是idx_seller_transNo索引。这是因为<strong>MySQL查询优化器是基于代价（cost-based）的查询方式。因此，在查询过程中，最重要的一部分是根据查询的SQL语句，依据多种索引，计算查询需要的代价，从而选择最优的索引方式生成查询计划。</strong></p>
<p>我们查询执行计划是在死锁发生之后做的，事后查询的执行计划和发绳死锁那一刻的索引使用情况并不一定相同的。但是，我们结合死锁日志，也可以定位到以上两条SQL语句执行的时候使用到的索引。即<strong>updateFundStreamId执行的时候使用到的是PRIMARY索引，updateStatus执行的时候使用到的是idx_seller_transNo索引</strong>。</p>
</blockquote>
<p>有了以上这些已知信息，我们就可以开始排查死锁原因及其背后的原理了。通过分析死锁日志，再结合我们的代码以及数据库建表语句，我们发现主要问题出在我们的idx_seller_transNo索引上面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KEY `idx_seller_transNo` (`seller_id`,`fund_transfer_order_no`(<span class="number">20</span>))</span><br></pre></td></tr></table></figure>
<p>索引创建语句中，我们使用了前缀索引，为了节约索引空间，提高索引效率，我们只选择了fund_transfer_order_no字段的前20位作为索引值。</p>
<p>因为fund_transfer_order_no只是普通索引，而非唯一性索引。又因为在一种特殊情况下，会有同一个用户的两个fund_transfer_order_no的前20位相同，这就导致两条不同的记录的索引值一样（因为seller_id 和fund_transfer_order_no(20)都相同 ）。</p>
<p>就如本文中的例子，发生死锁的两条记录的fund_transfer_order_no字段的值：99010015000805619031958363857和99010015000805619031957477256这两个就是前20位相同的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110517.png" alt=""></p>
<p>那么为什么fund_transfer_order_no的前20位相同会导致死锁呢？</p>
<h3 id="加锁原理"><a href="#加锁原理" class="headerlink" title="加锁原理"></a>加锁原理</h3><p>我们就拿本次的案例来看一下MySql数据库加锁的原理是怎样的，本文的死锁背后又发生了什么。</p>
<p>我们在数据库上模拟死锁场景，执行顺序如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">事务1</th>
<th style="text-align:center">事务2</th>
<th style="text-align:center">执行结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">update fund_transfer_stream set gmt_modified=now(),fund_transfer_order_no = ‘99010015000805619031958363857’ where id = 1 and seller_id = 3111095611;</td>
<td style="text-align:center"></td>
<td style="text-align:center">执行成功</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">begin</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">update fund_transfer_stream set gmt_modified=now(),fund_transfer_order_no = ‘99010015000805619031957477256’ where id = 2 and seller_id = 3111095611;</td>
<td style="text-align:center">执行成功</td>
</tr>
<tr>
<td style="text-align:center">update fund_transfer_stream set gmt_modified = NOW(), state = ‘PROCESSING’ where ((state = ‘NEW’) AND (seller_id = ‘3111095611’) AND (fund_transfer_order_no = ‘99010015000805619031958363857’));</td>
<td style="text-align:center"></td>
<td style="text-align:center">阻塞</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">update fund_transfer_stream set gmt_modified = NOW(), state = ‘PROCESSING’ where ((state = ‘NEW’) AND (seller_id = ‘3111095611’) AND (fund_transfer_order_no = ‘99010015000805619031957477256’));</td>
<td style="text-align:center">死锁</td>
</tr>
</tbody>
</table>
<p>我们知道，<strong>在MySQL中，行级锁并不是直接锁记录，而是锁索引。索引分为主键索引和非主键索引两种，如果一条sql语句操作了主键索引，MySQL就会锁定这条主键索引；如果一条语句操作了非主键索引，MySQL会先锁定该非主键索引，再锁定相关的主键索引。</strong></p>
<blockquote>
<p>主键索引的叶子节点存的是整行数据。在InnoDB中，主键索引也被称为聚簇索引（clustered index）</p>
<p>非主键索引的叶子节点的内容是主键的值，在InnoDB中，非主键索引也被称为非聚簇索引（secondary index）</p>
</blockquote>
<p>所以，本文的示例中涉及到的索引结构（索引是B+树，简化成表格了）如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110555.png" alt=""></p>
<p>死锁的发生与否，并不在于事务中有多少条SQL语句，<strong>死锁的关键在于：两个(或以上)的Session加锁的顺序不一致。</strong>那么接下来就看下上面的例子中两个事务的加锁顺序是怎样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110615.png" alt=""></p>
<p>下图是分解图，每一条SQL执行的时候加锁情况：</p>
<p><img src="https://cdn.jsdelivr.net/gh/removeif/blog_image/20190625110635.png" alt=""></p>
<p>结合以上两张图，我们发现了导致死锁的原因： 事务1执行update1占用PRIMARY = 1的锁 ——&gt; 事务2执行update1 占有PRIMARY = 2的锁； 事务1执行update2占有idx_seller_transNo = (3111095611，99010015000805619031)的锁，尝试占有PRIMARY = 2锁失败（阻塞）； 事务2执行update2尝试占有idx_seller_transNo = (3111095611，99010015000805619031)的锁失败（死锁）；</p>
<blockquote>
<p>事务在以非主键索引为where条件进行Update的时候，会先对该非主键索引加锁，然后再查询该非主键索引对应的主键索引都有哪些，再对这些主键索引进行加锁。）</p>
</blockquote>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>至此，我们分析清楚了导致死锁的根本原理以及其背后的原理。那么这个问题解决起来就不难了。</p>
<p>可以从两方面入手，分别是修改索引和修改代码（包含SQL语句）。</p>
<p>修改索引：只要我们把前缀索引 idx_seller_transNo中fund_transfer_order_no的前缀长度修改下就可以了。比如改成50。即可避免死锁。</p>
<p>但是，改了idx_seller_transNo的前缀长度后，可以解决死锁的前提条件是update语句真正执行的时候，会用到fund_transfer_order_no索引。如果MySQL查询优化器在代价分析之后，决定使用索引 KEY idx_seller(seller_id)，那么还是会存在死锁问题。原理和本文类似。</p>
<p>所以，根本解决办法就是改代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 所有update都通过主键ID进行。</span><br><span class="line">* 在同一个事务中，避免出现多条update语句修改同一条记录。</span><br></pre></td></tr></table></figure>
<h3 id="总结与思考"><a href="#总结与思考" class="headerlink" title="总结与思考"></a>总结与思考</h3><p>在死锁发生之后的一周内，我几乎每天都会抽空研究一会，问题早早的就定位到了，修改方案也有了，但是其中原理一直没搞清楚。</p>
<p>前前后后做过很多中种推断及假设，又都被自己一次次推翻。最终还是要靠实践来验证自己的想法。于是我自己在本地安装了数据库，实战的做了些测试，并实时查看数据库锁情况。<code>show engine innodb status ;</code>可以查看锁情况。最终才搞清楚原理。</p>
<p>简单说几点思考：</p>
<p>1、遇到问题，不要猜！！！亲手复现下问题，然后再来分析。</p>
<p>2、不要忽略上下文！！！我刚开始就是只关注死锁日志，一直忽略了代码中的事务其实还执行了另外一条SQL语句（updateFundStreamId）。</p>
<p>3、理论知识再充足，关键时刻不一定想的起来！！！</p>
<p>4、坑都是自己埋的！！！</p>
<p>参考资料：<br><a href="http://hedengcheng.com/?p=771" target="_blank" rel="noopener">MySQL 加锁处理分析</a></p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html" target="_blank" rel="noopener">innodb 事务隔离级别</a></p>
<p><a href="https://time.geekbang.org/column/intro/139" target="_blank" rel="noopener">《MySql实战45讲》</a></p>
<p><a href="https://www.hollischuang.com/archives/914" target="_blank" rel="noopener">MySQL中的行级锁,表级锁,页级锁</a></p>
<p><a href="https://www.hollischuang.com/archives/3461" target="_blank" rel="noopener">查看原文</a></p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    辣椒の酱
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://removeif.github.io/database/mysql/一次数据库的死锁问题排查过程.html" title="一次数据库的死锁问题排查过程">https://removeif.github.io/database/mysql/一次数据库的死锁问题排查过程.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
  <li class="post-copyright-license">
      <strong>文章评论：</strong>
      <a href="https://removeif.github.io/database/mysql/一次数据库的死锁问题排查过程.html#comment-container">点击评论</a>
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/remove.io/tags/mysql/" rel="tag"># mysql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/remove.io/theme/博客图片上传picgo工具github图传使用.html" rel="next" title="博客图片上传picgo工具github图传使用">
                <i class="fa fa-chevron-left"></i> 博客图片上传picgo工具github图传使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/remove.io/database/mysql/mysql索引优化方案.html" rel="prev" title="mysql索引优化方案">
                mysql索引优化方案 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://cdn.jsdelivr.net/gh/removeif/removeif.github.io@master/images/tuzi.jpg" alt="辣椒の酱">
            
              <p class="site-author-name" itemprop="name">辣椒の酱</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/remove.io/archives/">
              
                  <span class="site-state-item-count">81</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/remove.io/categories/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/remove.io/tags/index.html">
                  <span class="site-state-item-count">61</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/remove.io/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS

                <!-- <div>
                此处是广告
                </div>
                -->
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#现象"><span class="nav-number">1.</span> <span class="nav-text">现象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#背景情况"><span class="nav-number">2.</span> <span class="nav-text">背景情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#死锁日志"><span class="nav-number">3.</span> <span class="nav-text">死锁日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题排查"><span class="nav-number">4.</span> <span class="nav-text">问题排查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加锁原理"><span class="nav-number">5.</span> <span class="nav-text">加锁原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方法"><span class="nav-number">6.</span> <span class="nav-text">解决方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结与思考"><span class="nav-number">7.</span> <span class="nav-text">总结与思考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">辣椒の酱</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/remove.io/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/remove.io/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/remove.io/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/remove.io/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/remove.io/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/remove.io/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/remove.io/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/remove.io/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/remove.io/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/remove.io/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/remove.io/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/remove.io/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/remove.io/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
